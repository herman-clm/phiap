---
title: "Descriptive Statistics on v0.2.1 Bios Data"
output: 
  html_document:
    theme: journal
    toc: true
    toc_depth: 3
    number_sections: true
    fig_width: 15
    fig_height: 8
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, autodep=TRUE)

knitr::opts_chunk$set(cache = TRUE, warning = FALSE, 
                      message = FALSE)

suppressMessages(library(reshape2))
suppressMessages(library(lubridate))
suppressMessages(library(gridExtra))

suppressMessages(library(tidyverse))
suppressMessages(library(magrittr))
suppressMessages(library(ini))
suppressMessages(library(ggplot2))
suppressMessages(library(kableExtra))
suppressMessages(library(knitr))
suppressMessages(library(scales))
suppressMessages(library(reporttools))
suppressMessages(library(readxl))
suppressMessages(library(gtools))


```


```{r load_data, include=FALSE, cache=TRUE, cache.lazy=FALSE}
load("/data/processed_data/RAR/bios_data_enc_pts_v0.2.2_beta.RData")
```


# Aim 1
## Dx's
### Dx Basic
#### How many patients have >1 PA Dx's? {-}
In this v0.2.1 data, there are `r length(unique(pts$EMPI))` patients. The data is left censored, with a time cut-point of 1997-01-01. 
```{r pa_dx}
pa_dx_EMPI <- pts[which(pts$Dx_h1_Primary_aldosteronism_n >= 2), "EMPI"]
pa_dx_pts <- pts %>% filter(EMPI %in% pa_dx_EMPI$EMPI)
not_pa_dx_pts <- pts %>% filter(!(EMPI %in% pa_dx_EMPI$EMPI))
```
There are `r nrow(pa_dx_EMPI)` patients with more than 1 Primary Aldosteronism Dx in h1 level (Dx_h1_Primary_aldosteronism_n).   

#### In general, what is the distribution of PA Dx's? {-}
In `r length(unique(pts$EMPI))` patients, `r sum(pts$Dx_h1_Primary_aldosteronism_n != 0)` of them have PA Dx's. For those patients with PA Dx:
```{r dist_PA_dx}
pts %>% filter(Dx_h1_Primary_aldosteronism_n != 0) %>%
  select(Dx_h1_Primary_aldosteronism_n) %>%
  group_by(Dx_h1_Primary_aldosteronism_n) %>%
  summarise(N=n()) %>%
  ggplot(.) + geom_bar(aes(x=Dx_h1_Primary_aldosteronism_n, y=N), stat="identity")
```
Here is the summary for PA Dx in all patients and patients with PA Dx:
```{r sum_PA_dx}
summary(pts$Dx_h1_Primary_aldosteronism_n)
summary(pts %>% filter(Dx_h1_Primary_aldosteronism_n != 0) %>% select(Dx_h1_Primary_aldosteronism_n))
```
Use 8 as a Dx cut point: patients with more than 8 PA Dx are group together   



#### Using 14 (arbitrary) of PA Dx, descriptives between groups {-}
```{r new_dx_cut}
pts$PA_Dx <- ifelse(pts$Dx_h1_Primary_aldosteronism_n > 14, "14+", pts$Dx_h1_Primary_aldosteronism_n)
pts$PA_Dx <- factor(pts$PA_Dx, levels = mixedsort(unique(pts$PA_Dx)))
```
First, a brief descriptives on some variables:
```{r pa_dx_descriptives}
# numerics
num_var <- c("time_in_sys_yr", "time_to_1st_hyperaldo_dx_yr", "time_to_1st_RAR_yr", "high_BP_n", "high_BP_prop", "enc_n", 'enc_bp_n', 'high_BP_n', 'high_BP_prop', 'Aldo', "PRA", "DRC", "RAR_tests_n", "dbp", "sbp", "Test_POTASSIUM_mmol/L", "Dx_n", "Dx_h1_Primary_aldosteronism_n", "Dx_h1_Other_hyperaldo_n", "Dx_h1_Essential_HTN_n", "Dx_h1_Secondary_HTN_n", "Dx_h1_Obstructive_Sleep_Apnea_n", "Dx_h1_Other_Sleep_Apnea_n")

pts %>% group_by(PA_Dx) %>%
  mutate(N=n()) %>%
  summarise_at(vars(N, num_var), funs(median=median(., na.rm=T)))

# categoricals
pts %>% group_by(PA_Dx) %>%
  summarise(Gender_F = percent(sum(GENDER_MASTER_CODE =='F',na.rm=T)/n()), 
            RACE_Black = percent(sum(RACE_MASTER_CODE =='BLACK',na.rm=T)/n()),
            RACE_White = percent(sum(RACE_MASTER_CODE =='WHITE',na.rm=T)/n()), 
            Primary_ENTITY_CPUP = percent(sum(pri_entity =='CPUP',na.rm=T)/n()),
            Primary_ENTITY_CCA = percent(sum(pri_entity =='CCA',na.rm=T)/n()),
            Primary_Loc_RENAL_PERELMAN = percent(sum(pri_loc =='RENAL PERELMAN',na.rm=T)/n()),
            RAR_ENTITY_CPUP = percent(sum(rar_entity =='CPUP',na.rm=T)/n()),
            RAR_ENTITY_CCA = percent(sum(rar_entity =='CCA',na.rm=T)/n()),
            RAR_Loc_RENAL_PERELMAN = percent(sum(rar_loc =='RENAL PERELMAN',na.rm=T)/n())
            )
```

What about their distribution?
```{r pa_dx_tis_dist}
cc <- seq_gradient_pal("black", "red")(seq(0,1,length.out = 10))
pts %>% 
  filter(PA_Dx %in% c('2','3','4','5')) %>%
  ggplot(.) + geom_density(aes(time_in_sys_yr, group=PA_Dx, linetype=PA_Dx, color=PA_Dx)) + scale_color_manual(values=cc)
```


#### Using 0,1,2,3-5,6-9,9+ as PA Dx groupings {-}
Another way of grouping:
```{r new_6_grouping}
pts$PA_Dx <- case_when(pts$Dx_h1_Primary_aldosteronism_n == 0 ~ "0",
                       pts$Dx_h1_Primary_aldosteronism_n == 1 ~ "1",
                       pts$Dx_h1_Primary_aldosteronism_n == 2 ~ "2",
                       pts$Dx_h1_Primary_aldosteronism_n %in% c("3","4","5") ~ "3-5",
                       pts$Dx_h1_Primary_aldosteronism_n %in% c("6","7","8", "9") ~ "6-9",
                       TRUE ~ "9+")
```
Basic descriptives on new grouping
```{r pa_dx_descriptives_new}
# numerics
num_var <- c("time_in_sys_yr", "time_to_1st_hyperaldo_dx_yr", "time_to_1st_RAR_yr", "high_BP_n", "high_BP_prop", "enc_n", 'enc_bp_n', 'high_BP_n', 'high_BP_prop', 'Aldo', "PRA", "DRC", "RAR_tests_n", "dbp", "sbp", "Test_POTASSIUM_mmol/L", "Dx_n", "Dx_h1_Primary_aldosteronism_n", "Dx_h1_Other_hyperaldo_n", "Dx_h1_Essential_HTN_n", "Dx_h1_Secondary_HTN_n", "Dx_h1_Obstructive_Sleep_Apnea_n", "Dx_h1_Other_Sleep_Apnea_n")


median_quantile <- function(x){
  q1 = quantile(x, 0.25, na.rm=TRUE)
  q2 = quantile(x, 0.5, na.rm=TRUE)
  q3 = quantile(x, 0.75, na.rm=TRUE)
  missing_n = sum(is.na(x))
  ret <- sprintf("%.3f (%.3f ~ %.3f) [Missing: %d]", q2, q1, q3, missing_n)
  return(ret)
}

pts %>% group_by(PA_Dx) %>%
  mutate(N=n()) %>%
  summarise_at(vars(N, num_var), funs(median=median_quantile(.)))

temp <- pts[,c('PA_Dx', 'time_in_sys_yr')]
pairwise.wilcox.test(temp, 'PA_Dx')

# categoricals
pts %>% group_by(PA_Dx) %>%
  summarise(Gender_F = percent(sum(GENDER_MASTER_CODE =='F',na.rm=T)/n()), 
            RACE_Black = percent(sum(RACE_MASTER_CODE =='BLACK',na.rm=T)/n()),
            RACE_White = percent(sum(RACE_MASTER_CODE =='WHITE',na.rm=T)/n()), 
            Primary_ENTITY_CPUP = percent(sum(pri_entity =='CPUP',na.rm=T)/n()),
            Primary_ENTITY_CCA = percent(sum(pri_entity =='CCA',na.rm=T)/n()),
            Primary_Loc_RENAL_PERELMAN = percent(sum(pri_loc =='RENAL PERELMAN',na.rm=T)/n()),
            RAR_ENTITY_CPUP = percent(sum(rar_entity =='CPUP',na.rm=T)/n()),
            RAR_ENTITY_CCA = percent(sum(rar_entity =='CCA',na.rm=T)/n()),
            RAR_Loc_RENAL_PERELMAN = percent(sum(rar_loc =='RENAL PERELMAN',na.rm=T)/n())
            )
```


Plots:   
##### Time in system? {-}
```{r pa_dx_time_in_sys}
pts %>% ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = time_in_sys_yr))
```
A big decrease in group 2.   
```{r pa_dx_tis_dist_new_grp}
cc <- seq_gradient_pal("black", "red")(seq(0,1,length.out = 10))
pts %>% 
  ggplot(.) + geom_density(aes(time_in_sys_yr, group=PA_Dx, linetype=PA_Dx, color=PA_Dx),size=1) + scale_color_manual(values=cc)
```

```{r pa_dx_tis_dist_new_grp_2, fig.width=6,fig.height=15}
cc <- seq_gradient_pal("black", "red")(seq(0,1,length.out = 10))
g <- pts %>% 
  ggplot(.)
g <- g + geom_density(aes(time_in_sys_yr))
g <- g + facet_wrap(~ PA_Dx, scales = "free_y", ncol = 1)
g
```

##### Time to 1st RAR {-}
```{r pa_dx_time_to_1st_RAR}
pts %>% ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = time_to_1st_RAR_yr))
```



##### Time to 1st Hyperaldo Dx {-}
```{r pa_dx_time_to_1st_hyperaldo_Dx}
pts %>% ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = time_to_1st_hyperaldo_dx_yr))
```


##### Gender? {-}
```{r pa_dx_gender}
pts %>% select(PA_Dx, GENDER_MASTER_CODE) %>%
  group_by(PA_Dx, GENDER_MASTER_CODE) %>%
  summarise(N=n()) %>% ungroup() %>%
  group_by(PA_Dx) %>%
  mutate(percentage=N/sum(N)) %>%
  ggplot(.) + geom_bar(aes(x=PA_Dx, y=percentage, fill=GENDER_MASTER_CODE), stat="identity") +
  labs(y="Percentage")
```
```{r pa_dx_gender_rm0}
pts %>% select(PA_Dx, GENDER_MASTER_CODE) %>%
  filter(PA_Dx != "0") %>%
  ggplot(.) + geom_bar(aes(PA_Dx,fill=GENDER_MASTER_CODE), position='dodge')
```
For group with 2 PA Dx's, females are more than males. In other groups, females are fewer than males.   

##### Race? {-}
```{r pa_dx_race}
pts %>% select(PA_Dx, RACE_MASTER_CODE) %>%
  group_by(PA_Dx, RACE_MASTER_CODE) %>%
  summarise(N=n()) %>%
  ggplot(.) + geom_bar(aes(x=PA_Dx, y=N,fill=RACE_MASTER_CODE), position=position_fill(), stat="identity") + labs(y="Percentage")
```


```{r pa_dx_race_rm0}
pts %>% select(PA_Dx, RACE_MASTER_CODE) %>%
  filter(PA_Dx != "0") %>%
  ggplot(.) + geom_bar(aes(PA_Dx,fill=RACE_MASTER_CODE), position="dodge")
```

##### Encounter with BP number? {-}
```{r pa_dx_enc_bp_n}
pts %>% ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = enc_bp_n))
```
```{r pa_dx_enc_bp_n_rm0}
pts %>% 
  filter(PA_Dx != "0") %>%
  ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = enc_bp_n))
```

##### High BP? {-}
High BP number:
```{r pa_dx_high_bp_n}
pts %>% 
  filter(PA_Dx != "0") %>%
  ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = high_BP_n)) + scale_y_log10() + labs(y = "log(high BP n)")
```
There's no big difference between groups in high BP number.
High BP proportion:
```{r pa_dx_high_bp_prop}
pts %>% 
  filter(PA_Dx != "0") %>%
  ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = high_BP_prop))
```

##### Primary ENTITY {-}
```{r pa_dx_pri_entity}
pts %>% select(PA_Dx, pri_entity) %>%
  # filter(PA_Dx != "0") %>%
  group_by(PA_Dx, pri_entity) %>%
  summarise(N=n()) %>%
  ggplot(.) + geom_bar(aes(x=PA_Dx, y=N, fill=pri_entity), position=position_fill(), stat='identity')
```


##### RAR Test Results {-}
```{r pa_dx_Aldo}
pts %>% 
  ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = Aldo)) +
  geom_hline(yintercept = 15, linetype=2, color=2) + 
  scale_y_log10() + labs(y="log(Aldo)")
```
```{r pa_dx_PRA}
pts %>% 
  ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = PRA)) + 
  geom_hline(yintercept = 0.5, linetype=2, color=2) +
  scale_y_log10() + labs(y="log(PRA)")
```

The DRC for group 1 & 2 are not so accurate, since there are only 2 and 3 DRC's in these groups.   
For Aldo/PRA:
```{r pa_dx_rar_ratio}
pts %>% 
  ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = Aldo/PRA)) + 
  geom_hline(yintercept = 30, linetype=2, color=2) + 
  scale_y_log10() + 
  labs(y="log(Aldo/PRA)")
```
For Aldo/PRA ratio, grouping by RDB:
```{r pa_dx_rar_ratio_RDB}
pts %>% 
  ggplot(.) + geom_boxplot(aes(x=PA_Dx, y = Aldo/PRA, fill=PA_AVS_tot_0115)) + 
  geom_hline(yintercept = 30, linetype=2, color=2) + 
  scale_y_log10() + 
  labs(y="log(Aldo/PRA)")
```
##### Potassium {-}
```{r pa_dx_Potassium}
pts %>% ggplot(.) +
  geom_boxplot(aes(x=PA_Dx, y = pts$`Test_POTASSIUM_mmol/L`)) 
```
As for the IQR's, there is no big difference.

##### BP's associated with RAR
```{r pa_dx_sbp}
pts %>% ggplot(.) +
  geom_boxplot(aes(x=PA_Dx, y = sbp)) + 
  geom_hline(yintercept = 140, linetype=2, color=2)
```
```{r pa_dx_dbp}
pts %>% ggplot(.) +
  geom_boxplot(aes(x=PA_Dx, y = dbp))  + 
  geom_hline(yintercept = 90, linetype=2, color=2)
```

##### Number of all Dx's
```{r pa_dx_All_Dx}
pts %>% ggplot(.) +
  geom_boxplot(aes(x=PA_Dx, y = Dx_n)) + scale_y_log10()
```

#### Integrate with RAR Tests
```{r with_RAR_strict}
pts %>% 
  mutate(RAR_Strict = ifelse(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 30, TRUE, FALSE)) %>%
  select(RAR_Strict, PA_Dx) %>%
  table(., useNA="always")
```
If we apply PA Dx >= 2 as criteria, we could get several tables based on different RAR criteria:   

##### RAR Strict Criteria {-}
```{r with_RAR_strict_PA_criteria, echo=FALSE}
pts %>% 
  mutate(RAR_Strict_criteria = factor(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 30, levels=c(TRUE, FALSE)), 
         PA_Dx_C = factor(Dx_h1_Primary_aldosteronism_n >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Strict_criteria) %>%
  table(., useNA="always")
```

```{r with_RAR_strict_PA_criteria_PPV, echo=FALSE}
pts %>% 
  mutate(RAR_Strict_criteria = factor(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 30, levels=c(TRUE, FALSE)), 
         PA_Dx_C = factor(Dx_h1_Primary_aldosteronism_n >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Strict_criteria) %>%
  table(., useNA="always") %>%
  prop.table(., margin=1)
```
Apply RAR Strict criteria on encounter level:
```{r with_RAR_strict_PA_criteria_enc, echo=FALSE}
true_false_NA <- function(X){
  if(all(is.na(X))){
    return(NA)
  }else{
    return(any(X, na.rm = T))
  }
}


rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_Strict_criteria = factor(true_false_NA(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 30), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Strict_criteria) %>%
  table(., useNA="always")

```

```{r with_RAR_strict_PA_criteria_enc_PPV, echo=FALSE}
rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_Strict_criteria = factor(true_false_NA(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 30), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Strict_criteria) %>%
  table(., useNA="always") %>%
  prop.table(., margin=1)
```

```{r with_RAR_strict_PA_criteria_enc_sensitivity, echo=FALSE}
rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_Strict_criteria = factor(true_false_NA(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 30), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Strict_criteria) %>%
  table(., useNA="always") %>%
  prop.table(., margin=2)
```


```{r with_RAR_strict_PA_criteria_Venn}
VennDiagram::draw.pairwise.venn(area1=203+298, area2=203+158, cross.area = 203, 
                                category=c("RAR Strict Criteria", "PA_Dx >= 2"),
                                fill = c("light blue", "pink"), alpha = rep(0.5, 2), 
                                cat.pos = c(0, 0), cat.dist = rep(0.025, 2))
```


##### RAR PRA Criteria {-}
```{r with_RAR_PRA, echo=FALSE}
rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_PRA_criteria = factor(true_false_NA(Aldo >= 15 & PRA <= 1 & Aldo/PRA >= 30), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_PRA_criteria) %>%
  table(., useNA="always")

```

##### RAR ARR Criteria {-}
```{r with_RAR_ARR, echo=FALSE}
rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_ARR_criteria = factor(true_false_NA(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 20), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_ARR_criteria) %>%
  table(., useNA="always")

```
This result is same as that using strict RAR criteria.   

##### RAR Aldo Criteria {-}
```{r with_RAR_Aldo, echo=FALSE}
rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_Aldo_criteria = factor(true_false_NA(Aldo >= 10 & PRA <= 0.5 & Aldo/PRA >= 30), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Aldo_criteria) %>%
  table(., useNA="always")
```

##### RAR Lax Criteria {-}
```{r with_RAR_Lax, echo=FALSE}
lax <- rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_Lax_criteria = factor(true_false_NA(Aldo >= 10 & PRA <= 1 & Aldo/PRA >= 20), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Lax_criteria) %>%
  table(., useNA="always")
lax
```

```{r with_RAR_Lax_ppv, echo=FALSE}
rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_Lax_criteria = factor(true_false_NA(Aldo >= 10 & PRA <= 1 & Aldo/PRA >= 20), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Lax_criteria) %>%
  table(., useNA="always") %>%
  prop.table(., margin=1)
```

```{r with_RAR_Lax_sensitivity, echo=FALSE}
rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_Lax_criteria = factor(true_false_NA(Aldo >= 10 & PRA <= 1 & Aldo/PRA >= 20), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= 2, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Lax_criteria) %>%
  table(., useNA="always") %>%
  prop.table(., margin=2)
```

##### Changing RAR Lab Criteria, PA_Dx Criteria {-}

```{r foo, echo=FALSE}
foo <- function(dat, PA_Dx_C){
  
  dat %<>% select(EMPI, Aldo, PRA, Dx_h1_Primary_aldosteronism)
  
  strict <- dat %>% group_by(EMPI) %>%
  summarise(RAR_Strict_criteria = factor(true_false_NA(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 30), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= PA_Dx_C, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Strict_criteria) %>%
  table()
  
  
  pra <- dat %>% group_by(EMPI) %>%
  summarise(RAR_PRA_criteria = factor(true_false_NA(Aldo >= 15 & PRA <= 1 & Aldo/PRA >= 30), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= PA_Dx_C, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_PRA_criteria) %>%
  table()
  
  
  # arr <- dat %>% group_by(EMPI) %>%
  # summarise(RAR_ARR_criteria = factor(true_false_NA(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 20), levels=c(TRUE, FALSE)),
  #           PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= PA_Dx_C, levels=c(TRUE, FALSE))) %>%
  # select(PA_Dx_C, RAR_ARR_criteria) %>%
  # table()
  
  aldo <- dat %>% group_by(EMPI) %>%
  summarise(RAR_Aldo_criteria = factor(true_false_NA(Aldo >= 10 & PRA <= 0.5 & Aldo/PRA >= 30), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= PA_Dx_C, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Aldo_criteria) %>%
  table()
  
  lax <- dat %>% group_by(EMPI) %>%
  summarise(RAR_Lax_criteria = factor(true_false_NA(Aldo >= 10 & PRA <= 1 & Aldo/PRA >= 20), levels=c(TRUE, FALSE)),
            PA_Dx_C = factor(sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE) >= PA_Dx_C, levels=c(TRUE, FALSE))) %>%
  select(PA_Dx_C, RAR_Lax_criteria) %>%
  table()
  
  
  PA_p_RAR_p <- lapply(list(strict, pra, aldo, lax), function(X){X[1,1]}) %>% unlist
  
  PA_n_RAR_n <- lapply(list(strict, pra, aldo, lax), function(X){X[2,2]}) %>% unlist
  
  PA_p_RAR_n <- lapply(list(strict, pra, aldo, lax), function(X){X[1,2]}) %>% unlist
  
  PA_n_RAR_p <- lapply(list(strict, pra, aldo, lax), function(X){X[2,1]}) %>% unlist
  
  
  pp_on_PA_p <- PA_p_RAR_p/(PA_p_RAR_p + PA_p_RAR_n)
  pp_on_RAR_p <- PA_p_RAR_p/(PA_p_RAR_p + PA_n_RAR_p)
  
  
  temp <- data.frame(PA_Dx_N_Criteria = PA_Dx_C,PA_p_RAR_p = PA_p_RAR_p, PA_n_RAR_n = PA_n_RAR_n, 
                     PA_p_RAR_n = PA_p_RAR_n, PA_n_RAR_p = PA_n_RAR_p, 
                     pp_on_PA_p = pp_on_PA_p, pp_on_RAR_p = pp_on_RAR_p, RAR_Criteria = c("Strict","PRA","Aldo","Lax"))
  
  ret <- melt(temp, id.vars = c('PA_Dx_N_Criteria', "RAR_Criteria"))
  ret$RAR_Criteria <- factor(ret$RAR_Criteria, levels=c("Strict","PRA","Aldo","Lax"))
  
  return(ret)
}

```

```{r prepare_for_PA_Dx_all_plot}
all_pa_dx_C_list <- lapply(1:3, function(x){foo(rar_mg, PA_Dx_C = x)})
all_pa_dx_C <- do.call(rbind, all_pa_dx_C_list)
```

Make a plot!   
```{r pa_dx_1_2_3_plt_PPV}
all_pa_dx_C %>% filter(variable == "pp_on_PA_p" | variable == "pp_on_RAR_p") %>%
  mutate(variable = factor(variable, labels=c("P(PA+ & RAR+|PA+)", "P(PA+ & RAR+|RAR+)"))) %>%
  ggplot(.) + 
  geom_line(aes(x=RAR_Criteria, y = value, group=PA_Dx_N_Criteria, color=as.factor(PA_Dx_N_Criteria))) + 
  geom_point(aes(x=RAR_Criteria, y = value, group=PA_Dx_N_Criteria, color=as.factor(PA_Dx_N_Criteria))) + 
  labs(x="RAR Criteria", y= "Percentage") + 
  guides(color=guide_legend(title="# of PA Dx as Criterion")) + 
  scale_y_continuous(labels=percent) + facet_wrap(~variable, nrow = 2, scales = "free_y")

```


If change PA Dx from 3 to 5:
```{r pa_dx_1_to_7_plt_PPV_sensitivity}
all_pa_dx_C_list_N <- lapply(1:7, function(x){foo(rar_mg, PA_Dx_C = x)})
all_pa_dx_C_N <- do.call(rbind, all_pa_dx_C_list_N)

all_pa_dx_C_N %>% filter(variable == "pp_on_PA_p" | variable == "pp_on_RAR_p") %>%
  mutate(variable = factor(variable, labels=c("P(Dx+ & Lab+|Dx+)", "P(Dx+ & Lab+|Lab+)"))) %>%
  ggplot(.) + 
  geom_line(aes(x=RAR_Criteria, y = value, group=PA_Dx_N_Criteria, color=as.factor(PA_Dx_N_Criteria))) + 
  geom_point(aes(x=RAR_Criteria, y = value, group=PA_Dx_N_Criteria, color=as.factor(PA_Dx_N_Criteria))) + 
  labs(x="RAR Criteria", y= "Percentage") + 
  guides(color=guide_legend(title="# of PA Dx as Criterion")) + 
  scale_y_continuous(labels=percent) + facet_wrap(~variable, nrow = 2, scales = "free_y")

```
Take a look at patients in different Lab(+/-)/Dx(+/-) groups:
```{r pa_dx_1_2_3_plt_pts}
all_pa_dx_C %>% filter(variable %in% c("PA_p_RAR_p", "PA_n_RAR_n","PA_p_RAR_n","PA_n_RAR_p")) %>%
  mutate(variable = factor(variable, levels=c("PA_p_RAR_p", "PA_n_RAR_n","PA_p_RAR_n","PA_n_RAR_p"),
                           labels=c("Dx+ & Lab+","Dx- & Lab-","Dx+ & Lab-","Dx- & Lab+"))) %>%
  ggplot(.) + 
  geom_bar(aes(x=variable, y = value, fill=as.factor(RAR_Criteria)), position='dodge', stat = 'identity') + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~ PA_Dx_N_Criteria) + 
  labs(x="RAR Criteria", y= "Number of Patients", title="Number of Patients in different PA Dx Criteria and Lab RRA Criteria") + 
  theme(plot.title = element_text(hjust=0.5))
```
The {PA-, RAR-} group is always the highest, so remove it for a better view on others:
```{r pa_dx_1_2_3_plt_pts_no_tn}
all_pa_dx_C %>% filter(variable %in% c("PA_p_RAR_p","PA_p_RAR_n","PA_n_RAR_p")) %>%
  mutate(variable = factor(variable, levels=c("PA_p_RAR_p", "PA_n_RAR_n","PA_p_RAR_n","PA_n_RAR_p"),
                           labels=c("Dx+ & Lab+","Dx- & Lab-","Dx+ & Lab-","Dx- & Lab+"))) %>%
  ggplot(.) + 
  geom_bar(aes(x=variable, y = value, fill=as.factor(RAR_Criteria)), position='dodge', stat = 'identity') + 
  theme(axis.text.x = element_text(angle=90)) + 
  facet_wrap(~ PA_Dx_N_Criteria) + 
  labs(x="RAR Criteria", y= "Number of Patients", title="Number of Patients in different PA Dx Criteria and Lab RRA Criteria") + 
  theme(plot.title = element_text(hjust=0.5))
```

```{r pa_dx_1_2_3_plt_pts_no_tn_change}
all_pa_dx_C_N %>% filter(variable %in% c("PA_p_RAR_p","PA_p_RAR_n","PA_n_RAR_p")) %>%
  mutate(variable = factor(variable, levels=c("PA_p_RAR_p", "PA_n_RAR_n","PA_p_RAR_n","PA_n_RAR_p"),
                           labels=c("Dx+ & Lab+","Dx- & Lab-","Dx+ & Lab-","Dx- & Lab+"))) %>%
  ggplot(.) + 
  geom_bar(aes(x=RAR_Criteria, y = value, fill=as.factor(PA_Dx_N_Criteria)), position='dodge', stat = 'identity') + 
  theme(axis.text.x = element_text(angle=90)) + 
   facet_wrap(~ variable) + 
  labs(x="RAR Criteria", y= "Number of Patients", title="Number of Patients in different PA Dx Criteria and Lab RRA Criteria") + 
  theme(plot.title = element_text(hjust=0.5))
```

Another question is what is the union of PA+ and RAR+, according to different criterias:
```{r PA_Dx_union_RAR_plt_by_Dx}
all_pa_dx_C_N %>% filter(variable %in% c("PA_p_RAR_p","PA_p_RAR_n","PA_n_RAR_p")) %>%
  group_by(PA_Dx_N_Criteria, RAR_Criteria) %>%
  summarise(PA_union_Dx = sum(value)) %>%
  ggplot(.) + 
  geom_bar(aes(x=as.factor(PA_Dx_N_Criteria), y = PA_union_Dx, fill=as.factor(RAR_Criteria)), position='dodge', stat = 'identity') + 
  theme(axis.text.x = element_text(angle=90)) + 
  labs(x="Dx Criteria", y= "Number of Patients", title="Number of Patients in Dx+ or Lab+") + 
  theme(plot.title = element_text(hjust=0.5))
```

```{r PA_Dx_union_RAR_plt_by_RAR}
all_pa_dx_C_N %>% filter(variable %in% c("PA_p_RAR_p","PA_p_RAR_n","PA_n_RAR_p", "PA_n_RAR_n")) %>%
  mutate(v = ifelse(variable %in% c("PA_p_RAR_p","PA_p_RAR_n","PA_n_RAR_p"), "P","N")) %>%
  group_by(PA_Dx_N_Criteria, RAR_Criteria, v) %>%
  summarise(PA_union_Dx = sum(value)) %>% ungroup() %>%
  group_by(PA_Dx_N_Criteria, RAR_Criteria) %>%
  mutate(N = sum(PA_union_Dx)) %>%
  filter(v == "P") %>%
  mutate(PA_union_Dx_percent = PA_union_Dx/N) %>%
  ggplot(.) + 
  geom_bar(aes(x=as.factor(PA_Dx_N_Criteria), y = PA_union_Dx_percent, fill=as.factor(RAR_Criteria)), position='dodge', stat = 'identity') + 
  theme(axis.text.x = element_text(angle=90)) + 
  labs(x="Dx Criteria", y= "Percentage of Patients", title="Percentage of Patients in Dx+ or Lab+") + 
  theme(plot.title = element_text(hjust=0.5)) + scale_y_continuous(labels=percent)
```
```{r PA_Dx_union_RAR_plt_by_PA}
all_pa_dx_C_N %>% filter(variable %in% c("PA_p_RAR_p","PA_p_RAR_n","PA_n_RAR_p")) %>%
  group_by(PA_Dx_N_Criteria, RAR_Criteria) %>%
  summarise(PA_union_Dx = sum(value)) %>%
  ggplot(.) + 
  geom_bar(aes(x=as.factor(RAR_Criteria), y = PA_union_Dx, fill=as.factor(PA_Dx_N_Criteria)), position='dodge', stat = 'identity') + 
  theme(axis.text.x = element_text(angle=90)) + 
  labs(x="RAR Criteria", y= "Number of Patients", title="Number of Patients in Dx+ | Lab+") + 
  theme(plot.title = element_text(hjust=0.5))
```
The two plots above show that the number of patients in {PA+ or RAR+} is increasing when we change RAR Criteria from Strict to Lax for a specific PA Criteria; but for a specific RAR Criteria, the number of patients in {PA+ or RAR+} is decreasing when we increase the PA Criteria.

##### Who are discordant patients? -- RAR Strict + but only 0 or 1 PA Dx 
0/1 PA Dx:
```{r discordant_0_1_Dx}
rar_mg %>% group_by(EMPI) %>%
  summarise(RAR_Strict_criteria = (true_false_NA(Aldo >= 15 & PRA <= 0.5 & Aldo/PRA >= 30)),
            PA_Dx_C = (sum(Dx_h1_Primary_aldosteronism, na.rm=TRUE))) %>%
  ungroup() %>%
  filter(PA_Dx_C <= 1 & RAR_Strict_criteria)
```



#### Integrate with RDB
```{r pa_dx_RDB_tb, cache.lazy=FALSE}
# use the last record in DB as end date for right censoring
db_end_time <- as.Date("2015-10-01")

rar_mg_db <- rar_mg %>% filter(ENC_DATE <= db_end_time)
```



#### How many of the >1-PA-Dx patients have more than 2 encs? How many of them are in for >= 2 years? {-}
For these patients, `r nrow(pa_dx_pts %>% filter(enc_n >= 3))` have more than 2 encounters (all of them). And `r nrow(pa_dx_pts %>% filter(time_in_sys_yr >= 2))` of them have $\geqslant$ 2 years in UPHS system.   
In general, the encounters of them are:
```{r pa_dx_encs_hist}
ggplot(pa_dx_pts) + geom_histogram(aes(enc_n), bins=100) +
  labs(x = "Number of Encounters", y= "Count for Patients")
```
the range for number of encounters are:
```{r pa_dx_enc_sum}
summary(pa_dx_pts$enc_n)
```
As for the years, here is the summary:
```{r pa_dx_yr_sum}
summary(pa_dx_pts$time_in_sys_yr)
```
The density plot below is not as skewed as encounter plot:
```{r pa_dx_yr_hist}
ggplot(pa_dx_pts) + geom_density(aes(time_in_sys_yr)) +
  labs(x = "Years in System", y= "Density for Patients")
```
For time and encounter:
```{r pa_dx_yr_enc}
ggplot(pa_dx_pts) + geom_point(aes(x = time_in_sys_yr, y = enc_n, color = ifelse(time_in_sys_yr <= 1, "red", "blue")), alpha=0.5) + scale_color_identity()
```
red dots are patients whose Time in System is less than 1 year. All of them are in left bottom cornoer, which means their encounters are also low, less than 50:
```{r pa_dx_yr_enc_1_yr}
pa_dx_pts %>% filter(time_in_sys_yr <= 1) %>%
  ggplot(.) + geom_point(aes(x = time_in_sys_yr, y = enc_n), alpha=0.5) + scale_color_identity()
```


### Intersection with RDB
In total, there are `r sum(pts$PA_AVS_tot_0115)` patients in Research Data Base. Among them, `r sum(pa_dx_pts$PA_AVS_tot_0115)` (`r percent(sum(pa_dx_pts$PA_AVS_tot_0115)/sum(pts$PA_AVS_tot_0115))`) are in >1-Dx Group, which is only `r percent(nrow(pa_dx_EMPI)/nrow(pts))` of all patients. The popularity for each group is `r percent(sum(pa_dx_pts$PA_AVS_tot_0115==TRUE)/nrow(pa_dx_pts))` vs `r percent(nrow(not_pa_dx_pts %>% filter(PA_AVS_tot_0115))/nrow(not_pa_dx_pts))`, shown in plot:
```{r RDB_pa_dx_vs_non_pa_dx_plt}
pts %>% ungroup() %>% select(Dx_h1_Primary_aldosteronism_n, PA_AVS_tot_0115) %>%
  mutate(Dx_more_than_2 = Dx_h1_Primary_aldosteronism_n>=2) %>%
  group_by(Dx_more_than_2, PA_AVS_tot_0115) %>%
  summarise(N=n()) %>% ungroup() %>%
  group_by(Dx_more_than_2) %>%
  mutate(popularity = ifelse(PA_AVS_tot_0115, percent(N/sum(N)), NA)) %>%
  ggplot(.) + geom_bar(aes(x=Dx_more_than_2, y=N, fill=PA_AVS_tot_0115),stat="identity") + 
  geom_text(aes(x=Dx_more_than_2, y=N+200, label=popularity)) + 
  geom_text(aes(x=Dx_more_than_2, y=N+450, label=ifelse(PA_AVS_tot_0115, N, NA)))
```


#### What are differences between Dx_less_than_2 and Dx_greater_than_2 groups? {-}
Time in system?
```{r time_in_sys_Dx_2}
summary(pa_dx_pts$time_in_sys_yr)
summary(not_pa_dx_pts$time_in_sys_yr)
wilcox.test(pa_dx_pts$time_in_sys_yr, not_pa_dx_pts$time_in_sys_yr)
```
Time to 1st RAR test?
```{r time_to_1st_RAR_yr_Dx_2}
summary(pa_dx_pts$time_to_1st_RAR_yr)
summary(not_pa_dx_pts$time_to_1st_RAR_yr)
wilcox.test(pa_dx_pts$time_to_1st_RAR_yr, not_pa_dx_pts$time_to_1st_RAR_yr)
```
Note that for patients with more than 1 PA Dx, `r sum(is.na(pa_dx_pts$time_to_1st_RAR_yr))` of them do not have RAR test. In contratry, there are `r sum(is.na(not_pa_dx_pts$time_to_1st_RAR_yr))` in the other group. This means most RAR tests were performed on 1st PA Dx. (?)

More here...



The TRUE for RDB seem distributed everywhere...
```{r pa_dx_RDB_plt}
ggplot(pa_dx_pts) + geom_point(aes(x = time_in_sys_yr, y = enc_n, group=PA_AVS_tot_0115, color=PA_AVS_tot_0115), alpha=0.8) 
```






##### Different Intersection on 1-year criteria {-}
```{r split_on_1_yr}
pa_dx_1_yr <- pa_dx_pts %>% filter(time_in_sys_yr <= 1)
pa_dx_greater_1_yr <- pa_dx_pts %>% filter(time_in_sys_yr > 1)
```


```{r RDB_1_yr_vs_grt_1_yr_plt}
pa_dx_pts %>% ungroup() %>% select(Dx_h1_Primary_aldosteronism_n, PA_AVS_tot_0115, time_in_sys_yr) %>%
  mutate(Yr_greater_1_yr = time_in_sys_yr>=1) %>%
  group_by(Yr_greater_1_yr, PA_AVS_tot_0115) %>%
  summarise(N=n()) %>% ungroup() %>%
  group_by(Yr_greater_1_yr) %>%
  mutate(popularity = ifelse(PA_AVS_tot_0115, percent(N/sum(N)), NA)) %>%
  ggplot(.) + geom_bar(aes(x=Yr_greater_1_yr, y=N, fill=PA_AVS_tot_0115),stat="identity") + 
  geom_text(aes(x=Yr_greater_1_yr, y=N+100, label=popularity))
```
This plot shows that the RDB proportion is almost as twice higher in 1-year patient group than that in more-than-1-year group. Does this result from different time-to-1st-RAR tests?



# Not Our Patients?
```{r check_plt}
ggplot(pts) + geom_histogram(aes(time_to_1st_RAR_yr))

ggplot(pts) + geom_point(aes(x=(time_in_sys_yr*365.25), y = (time_to_1st_RAR_yr*365.25)), alpha=0.4)
ggplot(pts) + geom_point(aes(x=(time_in_sys_yr*365.25), y = (time_to_1st_RAR_yr*365.25),color=ifelse(enc_n > 10, "blue", "red")), alpha=0.4) + xlim(0, 5000) + ylim(0, 5000) + scale_color_identity()
```

