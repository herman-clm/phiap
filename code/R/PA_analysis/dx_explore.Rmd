---
title: "Diagnosis Code"
output: html_document
params:
  dev: false
  tocache: false
  log: 'NA'
---
```{r setup, include=FALSE, echo=FALSE, cache=FALSE}
setwd("~/repos/Daniel_Herman_Aldosterone_2017_03/code/R/PA_analysis")
library(tibble)
suppressMessages(library(dplyr))
suppressMessages(library(data.table))
suppressMessages(library(lubridate))
suppressMessages(library(dtplyr))
suppressMessages(library(magrittr))
suppressMessages(library(tidyr))
suppressWarnings(library(ggplot2))
suppressWarnings(library(sqldf))
suppressMessages(suppressWarnings(library(knitr)))
suppressMessages(suppressWarnings(library(logging)))

# load RAR data
source("pre_RARV2.R")
```

```{r load_data, cache=TRUE}
res1 <- pre_rar(dat_file_in = "/data/raw_data/PA/HERMANDA_RARV2.csv")
```

```{r load_dx, echo=FALSE}
dx <- fread("/data/raw_data/PA/HERMANDA_ALDO_DX.csv", stringsAsFactors = FALSE, header = TRUE)

temp <- fread("/data/raw_data/PA/HERMANDA_RAR_DX.csv", stringsAsFactors = FALSE, header = TRUE)

# make EMPI, MRN, PK_ENCOUNTER_ID, VISIT_NUMBER_NUM as characters
dx$EMPI <- as.character(dx$EMPI)
dx$MRN <- as.character(dx$MRN)
dx$PK_ENCOUNTER_ID <- as.character(dx$PK_ENCOUNTER_ID)
dx$VISIT_NUMBER_NUM <- as.character(dx$VISIT_NUMBER_NUM)  # resolve CHAR vs NUM

# change date
dx$ENC_DATE <- as.POSIXct(dx$ENC_DATE, format = "%Y-%m-%d %H:%M:%S")
dx$CODING_DATE <- as.POSIXct(dx$CODING_DATE, format = "%Y-%m-%d %H:%M:%S")

dx$PRIMARY_YN <- ifelse(dx$PRIMARY_YN == 0, FALSE, TRUE)

#dx <- as.tibble(dx)
dx <- as.data.frame(dx)

```

```{r dx_sum}
summary(dx)
```


There are only `r length(unique(dx$EMPI))` distinct EMPI's in HERMANDA_ALDO_DX.csv
There are `r length(unique(temp$EMPI))` distinct EMPI's in HERMANDA_RAR_DX.csv


ICD 9/10 codes: time
```{r}
range(dx[which(!grepl("E", dx$CODE)), "ENC_DATE"])

range(dx[which(grepl("E", dx$CODE)), "ENC_DATE"])

```



Select patients with more than 1 Dx
```{r}
# dx <- subset(dx,ENC_DATE >= '2015-01-01')
dx_empi <- sqldf("SELECT EMPI, count(*) as Dx_Count
                FROM dx
                GROUP BY EMPI
                HAVING count(*) >= 2")
length(unique(dx_empi$EMPI))
```
654 patients have 2 or more Dx.

Select them in test results.
```{r}

res1_dx <- subset(res1, EMPI %in% dx_empi$EMPI) # 2116 of 18925 obs
res1_dx0 <- subset(res1, !(EMPI %in% dx_empi$EMPI)) # 16809 of 18925 obs

length(unique(res1_dx$EMPI))
```
There are only 528 patients with 2 or more Dx who have test results.


```{r}
length(setdiff(dx_empi$EMPI, res1$EMPI))
```
There are 126 patients with 2 or more Dx who have no test results.



A quick check on COMMENTS
```{r}
dx %>% group_by(COMMENTS) %>%
  summarise(N=n()) %>%
  arrange(desc(N)) %>%
  print.data.frame()
```
Some of the COMMENTS show different PA groups which are not of interest here, e.g., "Pseudohyperaldosteronism / Liddle's syndrome", and some groups that are not sure, e.g., "?HYPERALDOSTERONISM".

Where does "Pseudohyperaldosteronism / Liddle's syndrome" come from?
```{r}
dx %>% filter(COMMENTS == "Pseudohyperaldosteronism / Liddle's syndrome") %>%
  group_by(CODE) %>%
  summarise(N=n()) %>%
  print.data.frame()
```
They all have ICD codes 255.11: Glucocorticoid-remediable aldosteronism   
But not all 255.11 have that COMMENTS:
```{r}
dx %>% filter(CODE == "255.11") %>% 
  group_by(COMMENTS) %>%
  summarise(N=n()) %>%
  print.data.frame()
```




### PRIMARY_YN/DX_SEQUENCE
```{r}
dx %>% 
  filter(PRIMARY_YN == 1 & DX_SEQUENCE != 1) %>%
  select(EMPI, CODE, ENC_DATE, DX_SEQUENCE, DX_TYPE)

```

```{r}
dx %>%  
  group_by(PRIMARY_YN, DX_SEQUENCE) %>%
  summarise(N=n()) %>%
  print.data.frame()
```


### Patients with $\geqslant 2$ Dx, but no test results

```{r}
dx_empi %>% filter(EMPI %in% setdiff(dx_empi$EMPI, res1_dx$EMPI)) %>%
  arrange(desc(Dx_Count))
```
Chart review on those patients (126).
chart_review_dx_explore.txt (1)
Some of them do have past ALDO/RENIN tests, but it's not included in data extraction.



```{r}
# Take a look at how many records each patient has
temp <- sqldf("SELECT EMPI, count(*) as Count
                FROM res1_dx
                GROUP BY EMPI
                ")
table(temp$Count)
```


######  Check Locations
Test results on patients with 2 or move Dx vs on patient with 1 or 0 Dx

Check by ORDER_GROUP
```{r}
temp1 <- res1_dx %>% group_by(ORDER_GROUP) %>% 
  summarise(N=n()/dim(res1_dx)[1]) %>% 
  ungroup() %>%
  arrange(desc(N)) %>%
  rename(., N_Dx2 = N)


temp2 <- res1_dx0 %>% group_by(ORDER_GROUP) %>% 
  summarise(N=n()/dim(res1_dx0)[1]) %>% 
  ungroup() %>%
  arrange(desc(N)) %>%
  rename(., N_Dx01 = N)

options(scipen=999) # turn off scientific notation. Default value is 0
merge(temp1, temp2, all = TRUE, by="ORDER_GROUP") %>% arrange(desc(N_Dx2))
```

Check by MASTER_LOCATION_DESCRIPTION
```{r}
temp1 <- res1_dx %>% group_by(MASTER_LOCATION_DESCRIPTION) %>% 
  summarise(N=n()) %>% 
  ungroup() %>%
  arrange(desc(N)) %>%
  rename(., N_Dx2 = N)


temp2 <- res1_dx0 %>% group_by(MASTER_LOCATION_DESCRIPTION) %>% 
  summarise(N=n()) %>% 
  ungroup() %>%
  arrange(desc(N)) %>%
  rename(., N_Dx01 = N)

merge(temp1, temp2, all = TRUE, by="MASTER_LOCATION_DESCRIPTION") %>% arrange(desc(N_Dx2))
```


There are some locations which are not shown in the first group: patients with 2 or more Dx and have test results.


######  Not sure Inpatient/Outpatient


######  Temporality
Check how many Dx these patients could have ($\geqslant 2$)
```{r}
dx_empi %>% group_by(Dx_Count) %>%
  summarise(N=n()) %>%
  arrange(Dx_Count)
```
Some patient has 100+ Dx...

Add Dx time stamps into Test Results. For now, use the earlist Dx date.   
Have a check on those whose first Dx dates are BEFORE tests
```{r}
first_dx <- dx %>% 
  filter(EMPI %in% dx_empi$EMPI) %>%
  group_by(EMPI) %>%
  summarise(DX_Date = min(ENC_DATE))


res1_dx_first_test <- res1_dx %>% group_by(EMPI) %>%
                          summarise(First_Test_Date = min(ENC_DATE))

temp <- merge(first_dx,res1_dx_first_test, by="EMPI") %>% filter(DX_Date < First_Test_Date)


range(temp$DX_Date)
range(temp$First_Test_Date)

```
194 out of 528 patients have a PA Dx BEFORE their first RENIN/ALDO tests.

Who are they?
chart_review_dx_explore.txt (2)
Most of them just do not have previous test results.



Select patients whose first Dx AFTER first ALDO/RENIN tests
```{r}
dx_aft_test_empi <- merge(first_dx,res1_dx_first_test, by="EMPI") %>% filter(DX_Date >= First_Test_Date)

# check RENIN
# t1: test results before first Dx
# t2: test results after first Dx
# tt: test results for those whose first Dx AFTER first ALDO/RENIN tests
t1 <- res1_dx %>% filter(RESULT_ITEM_CODE == "RENIN" &
                           EMPI %in% dx_aft_test_empi$EMPI) %>%
        merge(., first_dx, by="EMPI") %>%
        filter(ENC_DATE < DX_Date)

t2 <- res1_dx %>% filter(RESULT_ITEM_CODE == "RENIN" &
                           EMPI %in% dx_aft_test_empi$EMPI) %>%
        merge(., first_dx, by="EMPI") %>%
        filter(ENC_DATE >= DX_Date)


tt <- res1_dx %>% filter(RESULT_ITEM_CODE == "RENIN" &
                           EMPI %in% dx_aft_test_empi$EMPI) %>%
        merge(., first_dx, by="EMPI") %>%
        mutate(Time = as.numeric(ENC_DATE - DX_Date)/86400)

ggplot(data=tt, aes(x = Time, y = as.numeric(RESULT_VALUE), by = EMPI, col = EMPI)) + geom_point() + geom_line(lty=2) + theme(legend.position="none") + ylim(c(0,5)) + xlim(c(-365, 365))


# check ALDOSTERONE
# tt: test results for those whose first Dx AFTER first ALDO/RENIN tests

res1_dx %>% filter(RESULT_ITEM_CODE == "ALDOSTERONE" &
                           EMPI %in% dx_aft_test_empi$EMPI) %>%
        merge(., first_dx, by="EMPI") %>%
        mutate(Time = as.numeric(ENC_DATE - DX_Date)/86400) %>%
        ggplot(data=., aes(x = Time, y = as.numeric(RESULT_VALUE), by = EMPI, col = EMPI)) + geom_point() + geom_line(lty=2) + theme(legend.position="none")  + xlim(c(-365, 365))


```



#### 2 or more Encounters
```{r}
dp_col <- c("BIRTH_DATE","PATIENT_IDENTIFIER", "GENDER_MASTER_CODE")
res1_dx %>% arrange(EMPI, ORDER_START_DATE) %>% select(-one_of(dp_col)) %>%
  print.data.frame()
```

Define Encounter by VISIT_NUMBER/PK_ENCOUNTER_ID? Or different time?
```{r}
res1_dx %>% filter(EMPI == 1000195585) %>% arrange(ORDER_START_DATE) %>%
  print.data.frame()
```

Use PK_ENCOUNTER_ID now.
```{r}
empi_2_enc <- sqldf("SELECT EMPI, count(distinct PK_ENCOUNTER_ID) as Ct
        FROM res1_dx
        GROUP BY EMPI
        HAVING Ct > 2")
# 128 patients
```
128 patients who have 2 or more Dx have more than 2 encounters.


Select them in patients with 2 or more Dx:
```{r}
temp <- res1_dx %>% filter(EMPI %in% empi_2_enc$EMPI) %>%
  arrange(EMPI) %>%
  print.data.frame()
```
1052 records here.


Select those with duplicated PK_ENCOUNTER_ID
```{r}
temp_empi <- temp[duplicated(temp$PK_ENCOUNTER_ID),"EMPI"]

temp %>% filter(EMPI %in% temp_empi$EMPI) %>%
  print.data.frame()
```






















