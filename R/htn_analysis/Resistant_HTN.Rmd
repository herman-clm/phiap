---
title: "Resistant_HTN"
output: html_document
params:
  dev: false
  tocache: false
  log: 'NA'
---


```{r setup, echo=FALSE, cache=FALSE}
suppressMessages(library(dplyr))
suppressMessages(library(magrittr))
suppressMessages(library(dtplyr))
suppressMessages(library(data.table))
suppressMessages(library(tidyr))
suppressWarnings(library(ggplot2))
suppressMessages(suppressWarnings(library(RODBC)))
suppressMessages(suppressWarnings(library(knitr)))
suppressMessages(suppressWarnings(library(logging)))
suppressMessages(suppressWarnings(library(ROCR)))
suppressMessages(suppressWarnings(library(caret)))
source("../common_anal/R_fxns.R")
source("../common_anal/RAR_fxns.R")
```

* Blood pressures
```{r pull_BPs, cache=TRUE}

# Collect vital sign data
res_vitals <- load_RAR_vitals(x="~/Downloads/RHTN_vitals.csv")

# Wrange
res_vitals$ENC_DATE <- as.POSIXct(trunc(as.POSIXlt(res_vitals$ENC_DATE, format = "%d-%b-%Y %H:%M:%S"), "days"))
res_vitals <- unique(res_vitals)

# For each patient-encounter, calculate median
res_vitals %<>%
  tbl_df %>%
  group_by(EMPI, ENC_DATE) %>%
  summarize(SBP = as.double(median(BP_SYSTOLIC, na.rm=T)),
            DBP = as.double(median(BP_DIASTOLIC, na.rm=T))) %>% ungroup() 

# Select encounters consistent with hypertension
res_vitals %<>%
  filter(SBP > 140 & DBP > 90)
```

```{r char_BPs, cache=TRUE, dependson="pull_BPs"}
head(res_vitals)

res_vitals %>%
  summarize(n_htn_BPs = n(),
            n_htn_BP_EMPIs = length(unique(EMPI)),
            min_date = min(ENC_DATE),
            max_date = max(ENC_DATE),
            enc_pday = n_htn_BPs / as.numeric(difftime(max_date, min_date, units="days")))

res_vitals 

```

* Renin-aldosterone results
```{r load_RAR, cache=TRUE}

# Load renin-aldo test results
res1 <- load_RAR_specific()  #Aldo OR renin

```

```{r char_RAR, cache=TRUE, dependson="load_RAR"}

head(res1)

res1 %>%
  summarize(n = n(),
            n_EMPIs = length(unique(EMPI)),
            min_date = min(ORDER_START_DATE),
            max_date = max(ORDER_START_DATE)) %>%
  mutate(enc_pday = n / as.numeric(difftime(max_date, min_date, units="days")))

```

* Medications
```{r get_meds, cache=TRUE}

# Load anti-hypertensive medications
  res_meds <- load_RAR_meds(x="~/Downloads/RHTN_meds2.csv")

  res_meds %<>% 
    as_data_frame()
  
  # Approximate the pDOSE as % of high dose (90th percentile for each medication)
  res_meds %<>%
    group_by(SIMPLE_GENERIC_NAME) %>%
    mutate(pDOSE = DOSE / quantile(DOSE, probs=0.9, na.rm=T) * 100) %>% ungroup()
```

```{r char_meds, cache=TRUE, dependson="get_meds"}
head(res_meds)

res_meds %>%
  summarize(n = n(),
            n_EMPIs = length(unique(EMPI)),
            min_date = min(ORDER_START_DATE),
            max_date = max(ORDER_START_DATE)) %>%
  mutate(enc_pday = n / as.numeric(difftime(max_date, min_date, units="days")))

```

* Merge
```{r comb_meds_vitals, cache=TRUE, dependson=c("get_meds", "pull_BPs")}

drug_cats <- c("ACE_ARB", "CCBv", "Thiazide")  # Choose three medication classes

a <- res_meds %>%  # choose encounters with vitals and add all active drugs
  filter(DRUG_CLASS %in% drug_cats) %>%
  inner_join(res_vitals, by="EMPI") %>%
  filter((ENC_DATE > ORDER_START_DATE & 
            ENC_DATE <= ORDER_STOP_DATE)) %>%
  mutate(DRUG_CLASS = factor(DRUG_CLASS, levels=drug_cats))

a <- res_vitals %>%  # add back encounters with no meds
  left_join(a %>% select(-SBP, -DBP),
            by=c("EMPI", "ENC_DATE"))

# Calculate the total pDOSE for each DRUG_CLASS for each combo(EMPI, ENC_DATE)
a <- a %>%
  mutate(EMPI = factor(EMPI)) %>%
  group_by(EMPI, ENC_DATE, DRUG_CLASS) %>%
  summarize(sum_pDOSE = sum(pDOSE, na.rm=T)) %>% 
  ungroup() %>%
  complete(nesting(EMPI, ENC_DATE), DRUG_CLASS) %>%  # fill in all DRUG_CLASSes
  filter(!is.na(DRUG_CLASS))

a %<>%  # add up active drugs per category
    group_by(EMPI, ENC_DATE) %>%
    summarize(maxed_out = sum(sum_pDOSE >= 50, na.rm=T) == 3) %>% ungroup()

a2 <- res_meds %>%  # for each encounter chose the max Kspar dose at any earlier time (Ever taken?)
  filter(DRUG_CLASS == "K_sparing") %>%
  inner_join(res_vitals, by="EMPI") %>%
  filter(ENC_DATE > ORDER_START_DATE) %>%
  select(EMPI, ENC_DATE, SIMPLE_GENERIC_NAME, DOSE, pDOSE, ORDER_START_DATE, ORDER_STOP_DATE) %>%
  group_by(EMPI, ENC_DATE) %>%
  summarize(K_spar = max(pDOSE, na.rm=T)) %>% ungroup() 

a <- a %>%  # Add K_spar back to drugs/vitals
  mutate(EMPI = as.character(EMPI)) %>%
  left_join(a2 %>% mutate(EMPI = as.character(EMPI)), by=c("EMPI", "ENC_DATE"))
a$K_spar[which(is.na(a$K_spar))] <- 0
a$K_spar <- a$K_spar > 0
  
# Add BP back
a %<>%
  inner_join(res_vitals, by=c("EMPI", "ENC_DATE"))

a %<>%
  mutate(res_htn = maxed_out & !K_spar)

```

```{r add_labs, cache=TRUE, dependson=c("get_meds", "pull_BPs", "comb_meds_vitals", "load_RAR")}

# Add renin-aldo measurements
tmp <- res1 %>%
  select(EMPI, ORDER_START_DATE) %>%
  distinct()

tmp <- a %>% # add all aldo/renin at current or previous encounter
    left_join(tmp, 
              by="EMPI") %>%
    filter(ENC_DATE >= ORDER_START_DATE) %>%
  group_by(EMPI, ENC_DATE) %>%
  summarize(RAR = sum(!is.na(ORDER_START_DATE))) %>% ungroup() 

a %<>%
  left_join(tmp, by=c("EMPI", "ENC_DATE"))
a$RAR[which(is.na(a$RAR))] <- 0  
  
a %<>%
    mutate(res_htn_kr = maxed_out & !K_spar & (RAR == 0)) %>%
  select(-res_htn)
```

* Explore
```{r explore_all, cache=TRUE, dependson=c("get_meds", "pull_BPs", "comb_meds_vitals", "load_RAR", "add_labs")}

# table(a2$res_htn)  #1590
# length(unique(a2$EMPI[which(a2$res_htn)]))  #719
head(a)

a %>%
  summarize( n_enc = n(),
             n_EMPI = length(unique(EMPI)),
            n_maxed_out = sum(maxed_out),
             empi_maxed_out = length(unique(EMPI[which(maxed_out)])),
             n_maxed_out_nospar = sum(maxed_out & !K_spar),
         empi_maxed_out_nospar = length(unique(EMPI[which(maxed_out & !K_spar)])),
             n_maxed_out_nospar_noRAR = sum(maxed_out & !K_spar & (RAR == 0)),
                 empi_maxed_out_nospar_noRAR = length(unique(EMPI[which(maxed_out & !K_spar & (RAR == 0))]))
             ) %>%
  print.data.frame

table(a$maxed_out, a$K_spar, a$RAR > 0)

table(a$res_htn_kr)  #1346
length(unique(a$EMPI[which(a$res_htn_kr)]))  #629

# Have these patients been in the system for a while?
# Remind myself on the relevant timing issues...

```

```{r num_htn, cache=TRUE, dependson=c("get_meds", "pull_BPs", "comb_meds_vitals", "load_RAR", "add_labs")}


# Hypertensives
tmp_vitals <- res_vitals %>%
  group_by(EMPI) %>%
  summarize(count=n(),
            HTN = count > 1) %>% ungroup %>%
  filter(HTN) %>%
  distinct %>%
  collect %>% .[["EMPI"]]
length(tmp_vitals)

tmp_meds <- unique(res_meds$EMPI)
length(tmp_meds) 

tmp <- union(tmp_vitals, tmp_meds)
length(tmp)


```


We have all of the relevant lab tests
Have medications from 2014 on
Have BPs from 

  
  # res_meds %>%
  #   group_by(EMPI, DRUG_CLASS) %>%
  #   mutate(max_pDOSE = max(pDOSE, na.rm=T))  %>%
  #   summarize(maxed_out = sum(max_pDOSE[which(DRUG_CLASS %in% c("ACE_ARB", "CCBv", "Thiazide"))] >= 100, na.rm=T) == 3,
  #             K_spar = any(DRUG_CLASS == "K_spar", na.rm=T)) %>%
  #   mutate(res_htn = maxed_out & !spiro) %>% ungroup()  -> triple_meds

  # Make transaction list
  # med_starts <- res_meds %>%
  #   dplyr::select(EMPI, DtTm=ORDER_START_DATE, DRUG_CLASS, SIMPLE_GENERIC_NAME, pDOSE) %>%
  # mutate(ind=1:nrow(res_meds),
  #        action=factor("START", levels=c("STOP", "START")))
  # 
  # med_stops <- res_meds %>%
  #   dplyr::select(EMPI, DtTm=ORDER_STOP_DATE, DRUG_CLASS,  SIMPLE_GENERIC_NAME) %>%
  #   mutate(ind=1:nrow(res_meds),
  #          action=factor("STOP", levels=c("STOP", "START")),
  #          pDOSE=NA)
  # 
  # med_txs <- bind_rows(med_starts, med_stops) %>%
  #   arrange(EMPI, DRUG_CLASS, DtTm, action)
  # rm(med_starts, med_stops)
  # 
   # # Determine time for assessment
  # dates_to_eval <- res_meds %>%
  #   group_by(EMPI) %>%
  #   do( data.frame(start_date=sort(unique(c(.$ORDER_START_DATE, .$ORDER_STOP_DATE + 86400)))) ) %>%
  #   mutate(stop_date = lead(start_date) - 86400) %>%
  #   slice(-n()) %>% ungroup()
  # 
  # res_vitals <- inner_join(dates_to_eval, res_vitals, by="EMPI")
  # res_vitals %<>%
  #   filter(ENC_DATE >= start_date & ENC_DATE < stop_date)
  # 
  # Assess for res_HTN
  # tmp <- a %>% filter(EMPI %in% emps) %>%
  #   #filter(DRUG_CLASS %in% c("ACE_ARB", "CCBv", "Thiazide", "K_sparing")) %>%
  #   #mutate(DRUG_CLASS = factor(DRUG_CLASS, levels=c("ACE_ARB", "CCBv", "Thiazide", "K_sparing")),
  #   #       EMPI = factor(EMPI)) %>%
  #   group_by(EMPI, ENC_DATE) %>%
  #   do(meds_now_all(.)) %>%
  #   ungroup() %>% complete(EMPI, ENC_DATE)
  # 
  #pick highest
  # res_meds %<>%
  #   group_by(EMPI, PK_ENCOUNTER_ID, SIMPLE_GENERIC_NAME) %>%
  #   slice(which.max(DOSE)) %>% ungroup()
  # 
  